# ESP8266_MPU9250_MS5611_VARIO
DIY friendly, cheap, accurate, fast responding audio variometer using easily available modules

Software development platform used : Arduino 1.8.2 on Windows 10 x64

ESP8285  ESP-M2 module purchased from Aliexpress for US$1.80 including shipping. It was advertised as an ESP-M1 with 16Mbit flash, but the silkscreen on the back of the board shows ESP-M2, and the ESP8285 has an 8Mbit on-chip flash. You can use any ESP8266 module that brings out the gpio pins that are used in this project. I used an ESP8285 because it is literally thumbnail sized - an ESP8266 module would not have fit in the small plastic case I used for the project. If you do use ESP8266 instead of ESP8285, select "Generic ESP8266 module" for Arduino board type. If you decide to use a development board like the Wemos D1 or Nodemcu, bear in mind that the onboard USB-UART interface will draw current all the time, so the auto-power down feature will be compromised, as will the active power consumption.  I measured ~26mA current draw in active vario mode with the ESP8285 configured for 80MHz clock. 

CJMCU-117 MPU9250+MS5611 module, purchased from ebay for US$3.16 including shipping, when MS5611 modules were at least US$7 !! Prices have gone up now. The magnetometer isn't used in this project - I used this module because it was the cheapest IMU module available at the time with an MS5611 barometer.  I replaced the 10K I2C pullup resistors with 3K3 resistors for a more reliable interface with 400kHz I2C clock. I pulled up the PS and NCS pins to the CJMCU-117 LDO regulator output, not the schematic 3.3V.

Li-ion charger module, purchased from Electrodragon for US$0.50.  I cut the board in half to fit in the case I used, removing the battery connector, and soldered the lipoly battery wires directly to the charger board. I also reduced the charging current to match the 520mAH battery I used, by replacing the 1K5 charging current set resistor with 3K. See the MCP73831T datasheet for resistor values to suit your charging requirement. Rule of thumb is max charging current < 0.5C. The battery charger module isn't shown in the circuit schematic, you just have to connect the module output to the battery terminals - permanently.

I used a separate LDO regulator for powering the ESP8285. If you take power from the CJMCU-117 LDO regulator output, there will be a clearly apparent increase in barometer sensor noise. I recommend HT7333 for low dropout voltage and low quiescent current draw. The AMS117 regulator is unsuitable for this application.

Use a broadband piezo speaker like the Kingstate KPEG006 or similar part from PUI Audio. Most passive piezo buzzers are meant to be used as alarms at a resonant frequency, so are not a good match for this application. I'm fine with the volume as i use an open face helmet and don't like a loud vario. If you need more volume, you can use a dual inverting schmitt trigger chip e.g. SN74LVC2G14, connect the inverters in series to the pwm signal, and take the piezo connection from the two inverter outputs. With the inverter chip powered from VBAT, this will give you a push-pull configuration with peak to peak driving voltage of ~8V (VBAT x 2) rather than 3.3V. You can get a little more fancy and use a spare gpio pin + nchan mosfet + pchan mosfet to power the logic gates only when generating audio. Otherwise the piezo will always be polarized when the vario is on - that's not good for piezo working life.

Any external USB-UART module (FTDI232, CH340, CP2102) can be used for flashing the ESP8285. You can get one for about US$1 including shipping, from ebay, aliexpress etc. Ensure the USB-UART output logic level is at 3.3V. Only the TX, RX and GND pins of the USB-UART module should be connected to the ESP82xx. Connect TX / RX of the USB-UART module to RXD0 / TXD0 of the ESP82xx.  To put the ESP82xx in programming mode, power on the vario, press and hold the FLASH button, and then press the RESET button. I normally flash ESP8266 modules at 921600baud, but I had reliability problems flashing at more than 115200baud with the ESP8285. Make sure you use "Generic ESP8285 module" as board type for the ESP8285, as it uses a different internal SPI flash interface mode than the ESP8266.

The MPU9250 accelerometer and gyro biases will have to be calibrated for your unit. The gyro is calibrated each time on power on, but the accelerometer can be calibrated as well, by pressing the FLASH button when you hear the countdown beeps for the gyro calibration. See the code comments for further details. Calibration parameters are saved to and retrieved from flash. 

You will also have to map the sensor axes appropriately if you mount the sensor board in a different orientation. In my case the CJMCU-117 sensor board is horizontal, but upside down when the box is oriented normally with the piezo speaker on top. For debug purposes (testing yaw/pitch/roll calculations) the sensor board silkscreen +X points "forward", so the silkscreen +Y arrow points to the right. You should then get positive pitch when the box is rotated up (around the Y axis), positive roll when the box is rotated to the right (around the X axis), and positive yaw when the box is rotated flat (clockwise around the Z axis). Note that since the magnetometer isn't used the yaw value is initialized to 0 for whatever forward direction the unit is powered up with. 
